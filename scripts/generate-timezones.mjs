import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// where your source timezones module lives
const srcDir = path.join(__dirname, '..', 'src');
const candidates = [
  path.join(srcDir, 'timezones.js'),
  path.join(srcDir, 'timezones.mjs'),
  path.join(srcDir, 'timezones.cjs'),
  path.join(srcDir, 'timezones.ts'),
];

const modPath = candidates.find((p) => fs.existsSync(p));
if (!modPath) {
  console.error(
    `Cannot find timezones module. Tried:\n${candidates.join('\n')}`,
  );
  process.exit(1);
}

let mod;
try {
  mod = await import(`file://${modPath}`);
} catch (err) {
  console.error(`Failed to import ${modPath}:`, err);
  process.exit(1);
}

// Accept multiple export shapes
const timezones = mod.timezones ?? mod.default ?? mod;
if (!timezones || typeof timezones !== 'object') {
  console.error(
    `The imported module did not export a timezones object.\n` +
      `Module keys: ${Object.keys(mod).join(', ')}\n` +
      `Ensure the file exports like: export default timezones OR export const timezones = ...`,
  );
  process.exit(1);
}

// Output: single ESM module inside src/generated/timezones.js
const generatedDir = path.join(__dirname, '..', 'src', 'generated');
if (!fs.existsSync(generatedDir))
  fs.mkdirSync(generatedDir, { recursive: true });

const jsOutPath = path.join(generatedDir, 'timezones.js');

const jsContent =
  `// AUTO-GENERATED by scripts/generate-timezones.mjs — do not edit\n` +
  `/* eslint-disable */\n` +
  `const timezones = ${JSON.stringify(timezones)};\n\n` +
  `export default timezones;\n`;

fs.writeFileSync(jsOutPath, jsContent, 'utf8');

const sizeKB = (Buffer.byteLength(JSON.stringify(timezones)) / 1024).toFixed(1);
console.log(
  `✅ Wrote src/generated/timezones.js (${sizeKB} KB) — source: ${modPath}`,
);
